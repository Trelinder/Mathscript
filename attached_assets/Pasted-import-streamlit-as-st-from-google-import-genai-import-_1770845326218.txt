import streamlit as st
from google import genai
import datetime
import random
from fpdf import FPDF

# --- 1. APP CONFIGURATION & THEME ---
st.set_page_config(page_title="The Math Script: Ultimate Quest", page_icon="üéÆ", layout="wide")

# Custom Arcade CSS
st.markdown("""
    <style>
    .main { background-color: #0d1117; color: #ffffff; }
    .stButton>button {
        width: 100%; background: linear-gradient(45deg, #ff00cc, #3333ff);
        color: white; border: none; padding: 12px; font-size: 18px;
        font-family: 'Courier New'; border-radius: 10px; transition: 0.3s;
    }
    .stButton>button:hover { transform: scale(1.02); box-shadow: 0 0 15px #ff00cc; }
    .coin-box {
        background: #1e212b; border: 2px solid #ffd700; padding: 15px;
        border-radius: 15px; text-align: center; margin-bottom: 20px;
    }
    h1, h2, h3 { color: #00d4ff !important; text-shadow: 2px 2px #ff00cc; }
    </style>
    """, unsafe_allow_html=True)

# --- 2. INITIALIZE SESSION DATA ---
if 'coins' not in st.session_state: st.session_state.coins = 0
if 'inventory' not in st.session_state: st.session_state.inventory = []
if 'history' not in st.session_state: st.session_state.history = []
if 'onboarded' not in st.session_state: st.session_state.onboarded = False

# --- 3. HELPER FUNCTIONS ---
def generate_pdf(history):
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", 'B', 16)
    pdf.cell(200, 10, txt="Math Script Progress Report", ln=True, align='C')
    pdf.set_font("Arial", size=12)
    pdf.ln(10)
    for entry in history:
        pdf.cell(0, 10, txt=f"{entry['Time']} - {entry['Concept']} ({entry['Hero']})", ln=True)
    return pdf.output(dest='S').encode('latin-1')

# --- 4. ONBOARDING SCREEN ---
if not st.session_state.onboarded:
    st.title("üöÄ WELCOME TO THE MATH SCRIPT")
    st.markdown("""
    ### Your mission, should you choose to accept it:
    1. **Choose a Hero** to guide you through the Math Realms.
    2. **Fight Math Bosses** by turning scary problems into fun stories.
    3. **Earn Gold** to buy legendary gear in the Hero's Shop.
    4. **Level Up** your brain!
    """)
    if st.button("START MY FIRST MISSION"):
        st.session_state.onboarded = True
        st.rerun()
    st.stop()

# --- 5. SIDEBAR: SHOP & INVENTORY ---
with st.sidebar:
    st.title("üí∞ TREASURY")
    st.metric("Gold Coins", f"{st.session_state.coins}G")
    
    st.markdown("---")
    st.header("üõí HERO'S SHOP")
    shop_items = {"üî• Fire Sword": 100, "üõ°Ô∏è Ice Shield": 150, "‚ú® Magic Wand": 200, "ü¶ñ Dino Saddle": 300}
    
    for item, price in shop_items.items():
        if item in st.session_state.inventory:
            st.button(f"OWNED: {item}", disabled=True)
        else:
            if st.button(f"Buy {item} ({price}G)"):
                if st.session_state.coins >= price:
                    st.session_state.coins -= price
                    st.session_state.inventory.append(item)
                    st.toast(f"Unlocking {item}...")
                    st.rerun()
                else:
                    st.error("Need more Gold!")

    st.markdown("---")
    st.header("üéí INVENTORY")
    if st.session_state.inventory:
        for i in st.session_state.inventory: st.write(f"‚úÖ {i}")
    else: st.write("Empty...")

# --- 6. MAIN GAME LOGIC ---
st.title("üõ°Ô∏è THE MATH QUEST")

try:
    api_key = st.secrets["AIzaSyCWa47zq5XblGDH7elW4nuoeDPepdy-zoc"]
    client = genai.Client(api_key=api_key)
except:
    st.error("üõë API KEY MISSING. Add 'GEMINI_API_KEY' to Streamlit Secrets.")
    st.stop()

characters = {
    "Wizard üßô‚Äç‚ôÇÔ∏è": "uses magic potions and spellbooks",
    "Captain üöÄ": "uses spaceships and alien technology",
    "Dino ü¶ñ": "uses prehistoric stomping and fossils"
}

col1, col2 = st.columns([1, 2])
with col1:
    char_choice = st.radio("SELECT YOUR HERO:", list(characters.keys()))
with col2:
    math_input = st.text_input("THE MATH BOSS (Enter Problem):", placeholder="e.g. 12 x 8 or What is a fraction?")

if st.button("‚öîÔ∏è ATTACK WITH STORY"):
    if math_input:
        with st.spinner('Hero is casting a story spell...'):
            gear = ", ".join(st.session_state.inventory) if st.session_state.inventory else "bare hands"
            prompt = f"Explain {math_input} using a {char_choice} analogy. The hero is using {gear}. Keep it fun!"
            
            response = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
            
            # Update Progress
            st.session_state.coins += 50
            st.session_state.history.append({
                "Time": datetime.datetime.now().strftime("%Y-%m-%d"),
                "Concept": math_input, "Hero": char_choice
            })
            
            st.markdown("### üìú THE VICTORY STORY")
            st.write(response.text)
            st.balloons()
            st.toast("Victory! +50 Gold Earned!")
    else:
        st.warning("Enter a math problem to begin!")

# --- 7. PARENT DASHBOARD ---
st.markdown("<br><br>", unsafe_allow_html=True)
with st.expander("üîê PARENT COMMAND CENTER"):
    if st.session_state.history:
        st.table(st.session_state.history)
        if st.download_button("üìÑ Download PDF Report", data=generate_pdf(st.session_state.history), 
                              file_name="Math_Quest_Report.pdf", mime="application/pdf"):
            st.success("Report Generated!")
    else:
        st.write("No data yet. Start a quest to see progress!")